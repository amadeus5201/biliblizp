# 批量中奖监控功能使用说明

## 功能概述
批量中奖监控功能允许您同时监控多个B站抽奖活动，无需手动切换页面，可以统一管理所有监控任务。

## 主要特性

### 1. 多任务管理
- **添加任务**: 为每个监控任务设置名称和b23.tv短链接
- **任务列表**: 清晰显示所有监控任务的状态和进度
- **删除任务**: 可以随时删除不需要的监控任务

### 2. 全局控制
- **一键启动**: 点击"开始全部监控"按钮，同时启动所有任务
- **一键停止**: 点击"停止全部监控"按钮，同时停止所有任务
- **状态显示**: 实时显示全局监控状态

### 3. 实时统计
- **总任务数**: 显示当前添加的所有任务数量
- **监控中**: 显示正在运行监控的任务数量
- **有中奖者的任务**: 显示有第一个中奖者的任务数量
- **全局状态**: 显示整体监控系统的运行状态

### 4. 详细监控
- **任务详情**: 点击"详情"按钮查看单个任务的完整信息
- **最新中奖者**: 在详情页面查看该任务的最新中奖者信息
- **时间差显示**: 显示最新中奖者距离当前时间的时间差
- **新中奖通知**: 当发现新的中奖者时，系统会自动弹出通知

### 5. 自动抽奖功能
- **触发条件**: 检测到最近1分钟内的中奖记录时自动执行抽奖
- **Cookie配置**: 从cookie.txt文件读取B站cookie用于身份验证
- **抽奖结果**: 支持成功、失败、次数不足等多种状态
- **历史记录**: 在任务详情中查看所有自动抽奖的历史记录
- **智能停止**: 当抽奖次数不足时自动停止该任务监控

## 使用步骤

### 第一步：配置Cookie
1. 确保项目根目录下有cookie.txt文件
2. 在cookie.txt文件中添加您的B站cookie信息
3. Cookie格式：`SESSDATA=xxx; bili_jct=xxx; DedeUserID=xxx;`
4. 这些cookie将用于自动抽奖功能

### 第二步：添加监控任务
1. 打开"批量中奖监控"页面
2. 在"添加监控任务"区域输入：
   - **任务名称**: 给这个监控任务起一个容易识别的名字
   - **B站链接**: 输入要监控的B站链接（支持b23.tv短链接或bilibili.com/blackboard/开头的链接）
3. 点击"添加任务"按钮
4. 系统会自动解析链接，提取抽奖活动ID和taskId
5. 任务状态会显示为"就绪"

### 第二步：启动监控
1. **单个任务监控**: 
   - 在任务列表中点击对应任务的"开始"按钮
   - 该任务会开始独立监控

2. **批量监控**:
   - 点击"开始全部监控"按钮
   - 所有就绪状态的任务会同时开始监控
   - 系统会每秒检查一次所有活动的中奖名单

### 第三步：查看监控结果
1. **任务列表视图**:
   - 查看每个任务的状态（监控中/已停止/错误/抽奖次数不足）
   - 查看每个任务的中奖人数
   - 查看每个任务的检查次数

2. **详细视图**:
   - 点击任务列表中的"详情"按钮
   - 查看该任务的完整信息
   - 查看该任务的最新中奖者信息
   - 查看中奖时间和时间差
   - 查看自动抽奖历史记录

### 第四步：自动抽奖
1. **触发条件**: 当系统检测到1分钟内的中奖记录时
2. **自动执行**: 系统会自动调用B站抽奖API
3. **结果处理**:
   - 抽奖成功：显示成功消息，继续监控
   - 次数不足：自动停止该任务监控
   - 其他错误：记录错误信息，继续监控
4. **历史记录**: 所有抽奖结果都会记录在任务详情中

### 第五步：管理任务
1. **停止监控**:
   - 点击单个任务的"停止"按钮停止该任务
   - 点击"停止全部监控"按钮停止所有任务
   - 当抽奖次数不足时，系统会自动停止该任务

2. **删除任务**:
   - 点击任务列表中的删除图标
   - 确认删除后，任务会从列表中移除

## 界面说明

### 统计信息区域
- **总任务数**: 显示当前添加的所有任务数量
- **监控中**: 显示正在运行监控的任务数量（绿色显示）
- **有中奖者的任务**: 显示有第一个中奖者的任务数量（蓝色显示）
- **全局状态**: 显示整体监控系统的运行状态

### 添加任务区域
- **任务名称输入框**: 输入监控任务的名称
- **B站链接输入框**: 输入B站抽奖链接（支持b23.tv短链接或bilibili.com/blackboard/开头的链接）
- **添加任务按钮**: 点击后创建新的监控任务

### 全局控制区域
- **开始全部监控按钮**: 一键启动所有就绪状态的任务
- **停止全部监控按钮**: 一键停止所有正在监控的任务
- **状态标签**: 显示当前全局监控状态

### 任务列表区域
- **任务名称**: 显示任务的名称，如果有错误会显示红色错误标签
- **B站链接**: 显示任务的B站链接（自动截断显示）
- **状态**: 显示任务的当前状态（监控中/已停止/错误等）
- **最新中奖者**: 显示该任务的最新中奖者姓名（如果有的话）
- **检查次数**: 显示该任务的检查次数（仅在监控中时显示）
- **操作按钮**: 
  - 详情：查看任务的详细信息
  - 开始/停止：控制单个任务的监控状态
  - 删除：删除该任务

## 注意事项

### 1. 网络要求
- 确保网络连接稳定
- 确保能够访问B站API接口
- 建议在网络较好的环境下使用

### 2. 性能考虑
- 所有任务按顺序连续执行，完成即开始下一轮
- 每个任务间隔200毫秒，避免对B站API造成突发压力
- 建议同时监控的任务数量不超过20个
- 如果任务过多，可能会影响系统性能

### 3. 错误处理
- 如果短链接解析失败，任务状态会显示"解析失败"
- 如果API请求失败，任务状态会显示"请求失败"
- 可以查看任务详情了解具体的错误信息

### 4. 数据更新
- 最新中奖者信息会实时更新
- 新发现的中奖者会通过消息通知
- 时间差会实时计算并显示
- 自动抽奖结果会实时记录和显示

## 常见问题

### Q: 为什么任务状态显示"解析失败"？
A: 可能的原因：
- 链接格式不正确
- 网络连接问题
- B站页面结构发生变化
- 该抽奖活动已结束

### Q: 为什么没有发现新的中奖者？
A: 可能的原因：
- 该抽奖活动还没有中奖者
- 抽奖活动已结束
- API接口返回数据异常

### Q: 如何提高监控效率？
A: 建议：
- 只监控正在进行的抽奖活动
- 定期清理已结束的任务
- 确保网络连接稳定
- 避免同时监控过多任务
- 确保cookie.txt文件包含有效的B站cookie

### Q: 自动抽奖功能如何工作？
A: 工作原理：
- 系统检测到1分钟内的中奖记录时自动触发
- 从cookie.txt文件读取B站cookie
- 自动调用B站抽奖API
- 根据返回结果决定是否继续监控
- 所有抽奖记录都会保存在任务详情中

### Q: 为什么自动抽奖失败？
A: 可能的原因：
- cookie.txt文件不存在或格式错误
- cookie已过期或无效
- 网络连接问题
- B站API接口变化
- 该抽奖活动不支持自动抽奖

## 技术说明

### 监控原理
1. 解析B站链接（b23.tv短链接或bilibili.com/blackboard/开头的链接），获取真实的抽奖活动页面
2. 从页面中提取抽奖活动ID（lottery_id）和taskId
3. 使用抽奖活动ID调用B站中奖名单API
4. **连续顺序执行机制**: 所有任务按顺序连续执行，避免并发请求
   - 所有任务按顺序执行，任务间间隔200毫秒
   - 完成所有任务后立即开始下一轮循环
   - 无固定时间间隔，连续监控
5. 对比前后数据，发现新的中奖者时发送通知

### 自动抽奖原理
1. 检测到1分钟内的中奖记录时触发自动抽奖
2. 从cookie.txt文件读取B站cookie
3. 使用pageId和sid构建抽奖请求
4. 调用B站抽奖API（https://api.bilibili.com/x/lottery/x/do）
5. 根据返回结果处理：
   - code=0：抽奖成功，继续监控
   - code=170415：次数不足，停止监控
   - 其他：记录错误，继续监控

### 数据存储
- 所有数据存储在浏览器内存中
- 页面刷新后数据会丢失
- 建议定期记录重要的监控结果

### 安全考虑
- 所有请求都通过后端代理服务器
- 不会直接暴露用户的网络请求
- 遵循B站API的使用规范 