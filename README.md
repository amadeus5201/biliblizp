# Bilibili 监控分析系统

## 项目简介
这是一个专门用于B站相关功能的前端项目，主要功能包括：
- 分析B站动态页面中的链接
- 分析B站活动接口的不同参数组合
- 批量监控B站抽奖活动的最新中奖者
- 实时数据展示和通知
- **新增：自动验证码识别和处理功能**

## 技术栈
- **前端框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI组件**: Ant Design
- **状态管理**: Zustand
- **HTTP客户端**: Axios
- **样式**: Tailwind CSS
- **OCR服务**: 集成外部OCR服务用于验证码识别

## 功能模块

### 1. B站链接分析器 (BilibiliLinkAnalyzer)
- **功能**: 分析多个B站页面中的链接，支持批量处理
- **参数**:
  - 多个链接: 每行输入一个B站链接（支持动态、专栏、视频等）
  - 自动去重: 系统自动去除重复的链接
  - 链接过滤: 只显示b23.tv和bilibili.com链接
- **返回值**: 提取的不重复链接列表，支持复制、访问和批量添加到监控
- **新增验证码处理功能**:
  - 自动检测页面是否包含验证码
  - 自动提取验证码图片URL
  - 调用OCR服务自动识别验证码
  - 提供验证码确认和重新识别功能
  - 支持手动输入验证码
  - 验证码处理失败时可跳过继续处理其他链接

### 2. 活动接口分析器 (ActivityAnalyzer)
- **功能**: 分析B站活动接口的不同参数组合效果
- **参数**:
  - plat: 平台参数(1=PC, 2=移动端, 3=小程序)
  - mold: 类型参数(0=全部, 1=活动, 2=任务)
  - http: 协议参数(1=HTTP, 2=HTTPS, 3=自动)
  - pn/ps: 分页参数
- **返回值**: 不同参数组合的对比结果和差异分析

### 3. 批量中奖监控器 (BatchLotteryMonitor)
- **功能**: 同时监控多个B站抽奖活动的最新中奖者，支持自动抽奖功能
- **参数**:
  - 任务名称: 监控任务的标识名称
  - B站链接列表: 多个B站抽奖链接（支持b23.tv短链接或bilibili.com/blackboard/开头的链接）
  - Cookie配置: 从cookie.txt文件读取B站cookie用于自动抽奖
  - 全局控制: 一键开始/停止所有监控任务
- **返回值**: 多任务实时最新中奖者信息、任务状态统计、新中奖者通知、自动抽奖结果
- **请求机制**: 所有任务按顺序连续执行，任务间间隔200毫秒，完成即开始下一轮，避免对B站API造成突发压力
- **自动抽奖**: 检测到5分钟内中奖记录时自动执行抽奖，支持成功/失败/次数不足等状态处理
- **活动结束处理**: 自动检测活动结束状态，当活动结束时自动停止监控并更新任务状态
- **抽奖接口异常处理**: 自动检测抽奖接口异常（如Type字段验证失败），当检测到接口异常时停止监控

## 安装和运行

### 环境要求
- Node.js 16+
- npm 或 yarn
- **OCR服务**: 需要配置OCR服务地址（默认：http://192.168.31.40:9898）

### 安装依赖
```bash
npm install
```

### 启动开发服务器
```bash
npm run dev
```

### 构建生产版本
```bash
npm run build
```

## 使用说明

### 1. 分析B站链接
1. 打开"B站链接分析"页面
2. 在文本框中输入多个B站链接（每行一个）
3. 点击"批量分析"按钮
4. 系统会依次处理每个链接并自动去重
5. **如遇到验证码**：
   - 系统会自动检测并显示验证码图片
   - 自动调用OCR服务识别验证码
   - 显示识别结果供用户确认
   - 支持重新识别和手动输入
   - 可跳过验证码继续处理其他链接
6. 查看提取的不重复链接列表
7. 可选择全部或部分链接添加到批量监控

### 2. 分析活动接口
1. 打开"活动接口分析"页面
2. 点击"运行所有测试"按钮
3. 查看不同参数组合的对比结果
4. 分析参数对返回数据的影响

### 3. 批量监控中奖名单
1. 打开"批量中奖监控"页面
2. 确保cookie.txt文件包含有效的B站cookie
3. 添加多个监控任务（输入任务名称和B站链接）
4. 使用"开始全部监控"按钮一键启动所有任务
5. 系统采用连续顺序执行机制，所有任务按顺序执行，完成即开始下一轮
6. 当检测到5分钟内中奖记录时，系统会自动执行抽奖
7. 查看任务状态统计和实时最新中奖者信息
8. 点击"详情"按钮查看单个任务的详细信息，包括抽奖历史记录

## 验证码处理功能

### OCR服务配置
系统集成了外部OCR服务来处理B站验证码：
- **服务地址**: http://192.168.31.40:9898/ocr/url/text
- **请求方式**: POST
- **参数**: url (验证码图片URL)
- **返回**: 识别出的验证码文本

### 验证码处理流程
1. **自动检测**: 系统自动检测页面是否包含验证码
2. **图片提取**: 自动提取验证码图片URL
3. **OCR识别**: 调用OCR服务自动识别验证码
4. **用户确认**: 显示识别结果供用户确认或修改
5. **重新识别**: 支持重新调用OCR服务识别
6. **跳过处理**: 验证码处理失败时可跳过继续处理

### 验证码处理界面
- 显示验证码图片
- 显示OCR识别结果
- 支持手动修改验证码
- 提供重新识别按钮
- 支持查看大图功能
- 显示错误信息（如OCR识别失败）

## 项目结构
```
src/
├── components/          # 可复用组件
├── pages/              # 页面组件
│   ├── BilibiliLinkAnalyzer.tsx    # B站链接分析（含验证码处理）
│   ├── ActivityAnalyzer.tsx        # 活动接口分析
│   └── BatchLotteryMonitor.tsx     # 批量中奖监控
├── services/           # API服务
├── stores/             # 状态管理
├── types/              # TypeScript类型定义
├── utils/              # 工具函数
└── App.tsx             # 主应用组件
```

## 注意事项
- 请确保网络连接稳定，能够访问B站API
- 批量监控时建议同时监控的任务数量不超过10个
- 建议在开发环境中测试后再部署到生产环境
- 遵循B站API的使用规范，避免过于频繁的请求
- **OCR服务需要正常运行，否则验证码处理功能将无法使用**
- 验证码识别准确率取决于OCR服务的质量，建议人工确认识别结果

## 更新日志
- v1.2.2: 调整抽奖触发时间阈值
  - 将抽奖触发条件从1分钟内调整为5分钟内
  - 扩大抽奖触发范围，提高抽奖成功率
  - 更新相关文档说明，保持一致性
- v1.2.1: 新增抽奖触发条件调试功能
  - 添加详细的抽奖触发条件调试日志
  - 显示中奖时间、当前时间、时间差等信息
  - 帮助排查为什么某些中奖记录没有触发抽奖
  - 优化监控循环的日志输出，便于问题定位
- v1.2.0: 新增抽奖结果JSON显示和自动停止监控功能
  - 执行抽奖后自动显示完整的抽奖结果JSON
  - 不管抽奖接口返回什么结果，都自动停止该任务的监控
  - 添加抽奖结果JSON模态框，支持复制JSON内容
  - 优化抽奖流程，简化状态处理逻辑
- v1.1.9: 优化监控循环逻辑，避免无效请求
  - 修改监控循环，只执行正在监控的任务，跳过已停止的任务
  - 当所有任务都停止监控时，自动结束整个监控循环
  - 避免活动结束后继续调用lottery-list接口
  - 优化系统性能，减少无效的网络请求
- v1.1.8: 修正抽奖接口地址和参数
  - 修正抽奖接口地址为正确的B站API：https://api.bilibili.com/x/lottery/x/do
  - 使用正确的请求参数：sid、num、csrf、gaia_vtoken
  - 确保抽奖请求使用正确的B站官方接口
  - 优化接口调用逻辑，提高抽奖成功率
- v1.1.7: 新增抽奖接口异常检测和处理功能
  - 添加对抽奖接口异常状态码-400的检测
  - 当检测到Type字段验证失败等接口异常时自动停止监控
  - 优化错误处理逻辑，区分不同类型的抽奖失败情况
  - 完善任务状态显示，新增"抽奖接口异常"状态
- v1.1.6: 新增活动结束检测和处理功能
  - 添加对活动结束状态码170003的检测
  - 当检测到活动结束时自动停止监控并更新任务状态
  - 在抽奖请求中正确处理活动结束的响应
  - 优化任务状态显示，区分活动结束和抽奖次数不足
- v1.1.5: 修复抽奖次数判断和防重复调用问题
  - 修复抽奖次数判断逻辑，使用times字段而不是remain_times
  - 添加防重复调用机制，避免同一任务短时间内重复处理
  - 次数不足时保留任务在列表中但停止监控，而不是直接移除
  - 优化任务详情页面显示，正确显示抽奖次数信息
- v1.1.4: 添加抽奖次数监控功能
  - 集成lottery/x/mytimes接口，定期获取用户抽奖次数
  - 每5次检查调用一次抽奖次数接口，避免过于频繁
  - 在任务详情中显示剩余次数、已用次数、总次数
  - 完善监控逻辑，提供更全面的抽奖状态信息
- v1.1.3: 调整监控请求频率，降低对B站API的压力
  - 将任务间隔从200ms调整为500ms
  - 将轮次间隔从立即执行调整为2秒间隔
  - 优化监控逻辑，减少对B站服务器的请求压力
  - 保持监控效果的同时提高系统稳定性
- v1.1.2: 修复分析页面点击监控重复添加问题
  - 修复从分析页面点击监控按钮会添加重复任务的问题
  - 统一使用localStorage传递链接数据，避免URL参数和localStorage冲突
  - 简化批量监控页面的链接处理逻辑
  - 优化用户体验，避免重复添加相同任务
- v1.1.1: 修复批量中奖监控中B站链接显示问题
  - 修复表格中B站链接被截断的问题
  - 添加链接点击功能，支持在新窗口打开
  - 添加链接复制功能，方便用户复制链接
  - 优化任务详情页面中的链接显示
- v1.1.0: 新增验证码自动识别和处理功能
  - 自动检测页面验证码
  - 集成OCR服务自动识别
  - 提供验证码确认和重新识别功能
  - 支持跳过验证码继续处理
- v1.0.0: 初始版本，包含基础功能 